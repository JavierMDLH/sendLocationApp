<!DOCTYPE html>
<html>
<head>
    <title>GPS Finder - Webserber</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.1.2/socket.io.js"></script>
    <!-- Agrega la biblioteca Leaflet -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Merriweather:ital,wght@0,400;1,700&display=swap');
        /* Estilos para el cuadro de datos */
        #data-box {
            border: 2px solid #007BFF; /* Borde sólido azul */
            padding: 10px; /* Espaciado interior */
            font-family: 'Merriweather', serif; /* Fuente */
        }

        /* Estilos para el encabezado */
        #data-box h1 {
            background-color: #007BFF; /* Fondo azul para el encabezado */
            color: white; /* Texto blanco */
            padding: 10px; /* Espaciado interior */
            margin: 0; /* Elimina el margen predeterminado */
            display: inline-block; /* Hace que el fondo se ajuste al texto solamente */
            font-family: 'Merriweather', serif;
            border-radius: 10px; /* Agrega esquinas redondeadas */
        }

        /* Estilos para la tabla de datos históricos */
        table {
            border: 2px solid #007BFF; /* Borde sólido azul */
            border-collapse: collapse; /* Colapsar bordes de celda */
            width: 100%;
            font-family: 'Merriweather', serif;
            max-width: 600px; /* Limitar el ancho de la tabla */
            margin: 0 auto; /* Centra la tabla en la página */
            border-radius: 10px; /* Agrega esquinas redondeadas */
        }

        th, td {
            border: 1px solid #007BFF; /* Borde de celda azul */
            padding: 8px;
            text-align: left;
        }

        th {
            background-color: #007BFF; /* Fondo azul para encabezados de columna */
            color: white;
        }

        /* Resto de estilos */
    </style>

</head>
<body>
    <div id="data-box">
        <h1>GPS Finder - Webserber</h1>
        <p>Latitud: <span id="latitud"></span></p>
        <p>Longitud: <span id="longitud"></span></p>
        <p>Altitud: <span id="altitud"></span></p>
        <p>Timestamp: <span id="timestamp"></span></p>

        <!-- Agrega un contenedor para el mapa -->
        <div id="map" style="width: 100%; height: 400px;"></div>
        <!-- Botón para borrar polilíneas -->
        <button onclick="borrarPolilineas()">Borrar Polilíneas</button>

        <!-- Agrega una tabla para mostrar los datos del servidor -->
        <table>
            <thead>
                <tr>
                    <th>Latitud</th>
                    <th>Longitud</th>
                    <th>Altitud</th>
                    <th>Timestamp</th>
                </tr>
            </thead>
            <tbody id="data-table">
                <!-- Los datos del servidor se agregarán aquí dinámicamente -->
            </tbody>
        </table>
    </div>

    <script>
        const socket = io.connect('http://' + document.domain + ':' + location.port);
    
        socket.on('connect', function() {
            console.log('Conectado al servidor WebSocket');
        });
    
        socket.on('disconnect', function() {
            console.log('Desconectado del servidor WebSocket');
        });

        // Función para formatear la fecha
        function formatDate(timestamp) {
            const año = timestamp.substring(5, 9);
            const mes = timestamp.substring(3, 5);
            const dia = timestamp.substring(1, 3);
            const hora = timestamp.substring(9, 11);
            const minutos = timestamp.substring(11, 13);
            const segundos = timestamp.substring(13, 15);

            return `${dia}-${mes}-${año} ${hora}:${minutos}:${segundos}`;
        }

        // Crea un mapa Leaflet
        const map = L.map('map').setView([10.963237, -74.799345], 17); // Latitud y longitud iniciales y nivel de zoom

        // Agrega una capa de mapa de OpenStreetMap
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);

        let marker; // Variable para almacenar el marcador
        let previousPoint; // Variable para almacenar el punto anterior
        let opacity = 1; // Inicialmente, opacidad al 100%
        let polylines =[];

        socket.on('update_data', function(data) {
            console.log('Nuevos datos recibidos:', data);
            updateDataOnPage(data);
            updateDataTable(data);
        });

        function updateDataOnPage(data) {
            console.log('Actualizando datos en la página:', data);
            document.getElementById('latitud').innerText = data[0];
            document.getElementById('longitud').innerText = data[1];
            document.getElementById('altitud').innerText = data[2];
            document.getElementById('timestamp').innerText = formatDate(data[3]);

            // Actualiza la ubicación en el mapa
            const latitud = parseFloat(data[0]);
            const longitud = parseFloat(data[1]);

            if (!marker) {
                // Si no hay un marcador existente, crea uno nuevo
                marker = L.marker([latitud, longitud]).addTo(map);
            } else {
                // Si hay un marcador existente, actualiza su ubicación
                marker.setLatLng([latitud, longitud]);
            }

            if (previousPoint) {
                // Crea una nueva polyline desde el punto anterior al punto actual
                const polyline = L.polyline([previousPoint, [latitud, longitud]], { color: 'blue', opacity: opacity, dashArray: '10, 10' }).addTo(map);
                polylines.push(polyline);
            }

            // Almacena el punto actual como punto anterior para la próxima polyline
            previousPoint = [latitud, longitud];

            // Establece la vista del mapa en la nueva ubicación
            map.setView([latitud, longitud]);

            for (let i = 0; i < polylines.length - 1; i++) {
                const polyline = polylines[i];
                const currentOpacity = polyline.options.opacity;
                if (currentOpacity > 0) {
                    polyline.setStyle({ opacity: currentOpacity - 0.02 });
                }
            }
        }

        function updateDataTable(data) {
            // Obtén la tabla
            const table = document.getElementById('data-table');

            // Crea una nueva fila de datos
            const newRow = document.createElement('tr');

            // Itera a través de los datos y crea celdas para cada valor
            for (const value of data) {
                const cell = document.createElement('td');
                cell.innerText = value;
                newRow.appendChild(cell);
            }

            // Agrega la nueva fila en la parte superior de la tabla
            if (table.rows.length > 0) {
                table.insertBefore(newRow, table.rows[0]);
            } else {
                table.appendChild(newRow);
            }

            // Limita la cantidad de filas en la tabla, eliminando las más antiguas si es necesario
            const maxRows = 50; // Cambia este valor según tus preferencias
            while (table.rows.length > maxRows) {
                table.deleteRow(maxRows);
            }

        }
        // Función para borrar las polilíneas
        function borrarPolilineas() {
            for (let i = 0; i < polylines.length; i++) {
                const polyline = polylines[i];
                map.removeLayer(polyline);
            }
            polylines = [];
        }
    </script>
</body>
</html>
