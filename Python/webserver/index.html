<!DOCTYPE html>
<html>
<head>
    <title>Últimos datos recibidos</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.1.2/socket.io.js"></script>
    <!-- Agrega la biblioteca Leaflet -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
</head>
<body>
    <h1>Últimos datos recibidos:</h1>
    <p>Latitud: <span id="latitud"></span></p>
    <p>Longitud: <span id="longitud"></span></p>
    <p>Altitud: <span id="altitud"></span></p>
    <p>Timestamp: <span id="timestamp"></span></p>

    <!-- Agrega un contenedor para el mapa -->
    <div id="map" style="width: 100%; height: 400px;"></div>

    <script>
        const socket = io.connect('http://' + document.domain + ':' + location.port);
    
        socket.on('connect', function() {
            console.log('Conectado al servidor WebSocket');
        });
    
        socket.on('disconnect', function() {
            console.log('Desconectado del servidor WebSocket');
        });

        // Función para formatear la fecha
        function formatDate(timestamp) {
            const date = new Date(timestamp);
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            const seconds = String(date.getSeconds()).padStart(2, '0');
            return `${year}-${month}-${day} ${hours}:${minutes}:${seconds}`;
        }

        // Crea un mapa Leaflet
        const map = L.map('map').setView([0, 0], 17); // Latitud y longitud iniciales y nivel de zoom

        // Agrega una capa de mapa de OpenStreetMap
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);

        let marker; // Variable para almacenar el marcador
        let previousPoint; // Variable para almacenar el punto anterior
        let opacity = 1; // Inicialmente, opacidad al 100%
        let polylines =[];

        socket.on('update_data', function(data) {
            console.log('Nuevos datos recibidos:', data);
            updateDataOnPage(data);
        });

        function updateDataOnPage(data) {
            console.log('Actualizando datos en la página:', data);
            document.getElementById('latitud').innerText = data[0];
            document.getElementById('longitud').innerText = data[1];
            document.getElementById('altitud').innerText = data[2];
            console.log('Timestamp antes de formatear:', data[3]);
            document.getElementById('timestamp').innerText = formatDate(data[3]);

            // Actualiza la ubicación en el mapa
            const latitud = parseFloat(data[0]);
            const longitud = parseFloat(data[1]);

            if (!marker) {
                // Si no hay un marcador existente, crea uno nuevo
                marker = L.marker([latitud, longitud]).addTo(map);
                console.log('Marker creado');
            } else {
                // Si hay un marcador existente, actualiza su ubicación
                marker.setLatLng([latitud, longitud]);
                console.log('Marker actualizado');
            }

            // Crea una nueva polyline con opacidad actual
            const newPolyline = L.polyline([[latitud, longitud]], { color: 'blue', opacity: 1 }).addTo(map);
            console.log('Polyline creada');

            // Agrega la nueva polyline al arreglo de polylines
            polylines.push(newPolyline);

            // Establece la vista del mapa en la nueva ubicación
            map.setView([latitud, longitud]);

            // Reduce la opacidad de las polylines anteriores
            for (let i = 0; i < polylines.length - 1; i++) {
                const polyline = polylines[i];
                const currentOpacity = polyline.options.opacity;
                if (currentOpacity > 0) {
                    polyline.setStyle({ opacity: currentOpacity - 0.1 });
                }
            }

        }
    </script>
</body>
</html>
